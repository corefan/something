<!DOCTYPE html>
<html>
<head lang="ko">
    <meta charset="UTF-8">
    <title>360_video</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no,target-densitydpi=high-dpi "/>
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100%;
        }
    </style>
    <script>
        function _click(){
            _vd.src = "http://172.10.12.61:9090/media/12244877_133753896986094_1384461755_n.mp4";
        }        
    </script>
    <script id="v" type="text/v">
attribute vec3 aVertexPosition;
attribute vec2 aTextureCoord;
uniform mat4 uMVMatrix;
uniform mat4 uPMatrix;
varying highp vec2 vTextureCoord;
void main(void) {
    gl_Position = uPMatrix*uMVMatrix*vec4(aVertexPosition, 1.0);
    vTextureCoord = aTextureCoord;
}
	</script>
	
	<script id="f" type="text/f">
varying highp vec2 vTextureCoord;
uniform sampler2D uSampler;
void main(void) {
    gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
}    
	</script>
</head>
<body>
<div style="position: absolute; left:30px; top:30px; width: 512px; height: 512px; border: 3px solid #eeeeee;">    
	<canvas id="gl_canvas" width="512" height="512" onclick="_click()">
	</canvas>
</div>
<!--<div style="position: absolute; left:30px; top:300px; width: 400px; height: 300px; border: 3px solid #eeeeee;">    
    <video id="video" width="400px" height="300px"></video>
</div>-->
</body>
<script>
    (function(win, width, height){
        var intervalID;
        // var vd = document.getElementById("video");
        var vd = window._vd = document.createElement("video");
        vd.addEventListener("canplaythrough", startVideo, false);
        vd.addEventListener("ended", endVideo , false);
        
        function startVideo(){
            start();
            intervalID = setInterval(start, 64);
            vd.play();
        }
        
        function endVideo(){
            vd.play();
            // clearInterval(intervalID);
        }
        
        var cv = document.getElementById("gl_canvas");
        cv.width = width;
        cv.height = height;
        cv.parentNode.style.width = width + "px";
        cv.parentNode.style.height = height + "px";
        var gl = cv.getContext("webgl");
                
        var vertexShader = gl.createShader(gl.VERTEX_SHADER);
        gl.shaderSource(vertexShader, document.getElementById("v").text);
        gl.compileShader(vertexShader);
        
        var fragmentShader = gl.createShader(gl.FRAGMENT_SHADER);
        gl.shaderSource(fragmentShader, document.getElementById("f").text);
        gl.compileShader(fragmentShader);
        
        var program = gl.createProgram();
        gl.attachShader(program, vertexShader);
        gl.attachShader(program, fragmentShader);
        gl.linkProgram(program);        
        gl.useProgram(program);
        
        program.aVertexPosition = gl.getAttribLocation(program, "aVertexPosition");
        gl.enableVertexAttribArray(program.aVertexPosition);
        program.aTextureCoord = gl.getAttribLocation(program, "aTextureCoord");
        gl.enableVertexAttribArray(program.aTextureCoord);
        
        program.uPMatrix = gl.getUniformLocation(program, "uPMatrix");
        gl.enableVertexAttribArray(program.aTextureCoord);       
        program.uMVMatrix = gl.getUniformLocation(program, "uMVMatrix");
        gl.enableVertexAttribArray(program.aTextureCoord);                      
        program.uSampler = gl.getUniformLocation(program, "uSampler");                       
                       
        gl.viewport(0,0, width, height);
        
        var vertex_data = [];       
        var index_data = [];
        var uv_data = [];
        
        var p_data = [0.8021504282951355, 0, 0, 0, 0, 1.4281480312347412, 0, 0, 0, 0, -1.0020020008087158, -1, 0, 0, -0.20020020008087158, 0];
        var mv_data = [-0.0019187201978638768, -0, -0.999998152256012, -0, 0, 1, 0, 0, 0.999998152256012, 0, -0.0019187201978638768, 0, 0, 0, 0, 1];
        
        uv_data.push(0.001666666666666668,0.5025,0.33166666666666667,0.5025,0.33166666666666667,0.9975,0.001666666666666668,0.9975,0.33499999999999996,0.5025,0.665,0.5025,0.665,0.9975,0.33499999999999996,0.9975,0.6683333333333332,0.5025,0.9983333333333333,0.5025,0.9983333333333333,0.9975,0.6683333333333332,0.9975,0.001666666666666668,0.0025000000000000022,0.33166666666666667,0.0025000000000000022,0.33166666666666667,0.4975,0.001666666666666668,0.4975,0.33499999999999996,0.0025000000000000022,0.665,0.0025000000000000022,0.665,0.4975,0.33499999999999996,0.4975,0.6683333333333332,0.0025000000000000022,0.9983333333333333,0.0025000000000000022,0.9983333333333333,0.4975,0.6683333333333332,0.4975);
        index_data.push(0,2,1,0,3,2,4,6,5,4,7,6,8,10,9,8,11,10,12,14,13,12,15,14,16,18,17,16,19,18,20,22,21,20,23,22);
        vertex_data.push(1,-1,1,-1,-1,1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,1,1,-1,-1,1,-1,1,1,-1,1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,-1,1,1,-1,-1,1,-1,-1,1,-1,1,1,1,1,1,1,-1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1);
        
        

        var cubeTexture = gl.createTexture();
        gl.bindTexture(gl.TEXTURE_2D, cubeTexture);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
                
        var vertexBuffer = gl.createBuffer(gl.ARRAY_BUFFER);
        gl.bindBuffer(gl.ARRAY_BUFFER, vertexBuffer);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertex_data), gl.STATIC_DRAW);
        gl.vertexAttribPointer(program.aVertexPosition, 3, gl.FLOAT, false, 0, 0);
               
        var uvBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, uvBuffer);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(uv_data), gl.STATIC_DRAW);
        gl.vertexAttribPointer(program.aTextureCoord, 2, gl.FLOAT, false, 0, 0);
        
        var indexBuffer = gl.createBuffer(gl.ELEMENT_ARRAY_BUFFER);
        gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, indexBuffer);
        gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Uint16Array(index_data), gl.STATIC_DRAW);        
        
        
        gl.uniformMatrix4fv(program.uPMatrix, false, p_data);
        gl.uniformMatrix4fv(program.uMVMatrix, false, mv_data);
        gl.uniform1i(program.uSampler, 0);
        
        // gl.enable(gl.DEPTH_TEST); 
        // gl.depthFunc(gl.LESS);
  
                
        function start(){
            gl.clearColor(1, 1, 1, 1);  
            gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
                        
            gl.bindTexture(gl.TEXTURE_2D, cubeTexture);
            gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);
            gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, vd);    
                                        
            gl.drawElements(gl.TRIANGLES, 36, gl.UNSIGNED_SHORT, 0);
        }
        
    })(this, 400, 300);
</script>
</html>